Анализ тональности комментариев в социальных сетях: создание карты эмоций жителей Санкт-Петербурга
А.В. Чижик1, С.А. Мельникова2, В.П. Захаров1
Введение
Одним из важнейших аспектов социологического анализа современных тенденций развития общества является изучение социального настроения населения, которое является в некотором смысле доминантой функционирующего сознания. Это – один из интегральных показателей восприятия населением социальных и экономико-политических процессов, который выступает индикатором определения уровня благополучия, социальной устроенности общества. На основании исследований социального настроения можно проследить энергетические потенциалы общества, которые, отталкиваясь от быстроизменяющейся ситуации в стране и мире, способны перерастать в процессы, формирующие политический строй и такие институты как гражданское общество.
Необходимо различать два понятия, используемых в социологии, психологии и философии: индивидуальное настроение и групповое, которые часто связаны друг с другом за счет цепной реакции, свойственной в поведении любого социума. Большой рывок в изучении механизмов формирования индивидуального настроения сделал советский психолог и философ Д.Н. Узнадзе, который говорил о том, что на восприятии той или иной ситуации сказывается динамический стереотип восприятия, 
являющийся психофизической основой настроения индивида [1]. Таким образом, в настроении как целостной форме жизнеощущения человека находят свое выражение социальные процессы. В данном случае уже можно говорить о том, что индивидуальное настроение влияет на атмосферу в обществе, однако надо понимать, что оно хотя и относительно устойчивое явление, но слабо выраженное или быстро угасающее. Значит, для оценки ситуации в стране следует обращаться к анализу социального настроения, которое формируется на основе индивидуального. Имеет смысл разделять следующие виды социального настроения: «групповое настроение», «политическое настроение», «массовое настроение» (В.А. Ядов) [2]. Надо отметить, что каждый из видов социального настроения имеет свое отражение на социально-психологическом климате общества и может проявляться как в глобальном ключе (митинги, восстания и пр.), так и в локальном. Б.Ф. Поршнев, философ и социолог, который ввел само понятие «социальное настроение» в русскую науку, делает следующий вывод: «социальное настроение – это эмоциональные состояния, связанные с осуществлением или неосуществленностью, с разными формами осуществления тех или иных надежд и чаяний, помыслов и замыслов. Как правило, социальное настроение – это эмоциональное отношение к тому, что стоит на пути, кто мешает, или, напротив, кто помогает воплощению желаемого в жизнь» [3]. То есть Поршнев подчеркивает присутствие субъекта и объекта настроения, что для социологической интерпретации очень важно.
Благодаря доступности интернета и простоте выражения мыслей в формируемом на его базисе виртуальном пространстве, интеграции социальных сетей в повседневные практики всех возрастных групп и, соответственно, возможности быстрого коллективного взаимодействия индивидов люди проводят в этом контексте большую часть своего времени [4, 5, 6]. Актуализированное социальными сетями смещение временных и пространственных ограничений приводит к быстрому распространению реакций общества на городскую повестку дня, это означает, что внутри публичных обсуждений появляется большой массив текстовых данных, который содержит эмоционально окрашенные комментарии пользователей, с зафиксированными тематическими отсылками [7]. Поэтому социальные медиа стали источником большого количества открытых данных, которые содержат неструктурированную (но поддающуюся анализу методами NLP и машинного обучения) информацию о поведении аудитории на фоне возникающих публичных обсуждений информационной повестки дня и событий, окружающих их в локации проживания. Так мы можем получить ценную информацию о динамике функционирования социальной группы, такую как эмоции индивидов, сливающиеся в социальное настроение, и изменения в обществе (как глобальной структуры), которые базируются, как правило, именно на эмоциональном состоянии социальной группы. 
Целью данного исследования была разработка методики сбора, предобработки данных и последующего анализа тональности комментариев пользователей. Таким образом, эмпирическая часть исследования была направлена на изучение механизма распространения эмоций через анализ активности взаимодействия и коммуникативных особенностей отношений индивидов в социальных сетях. В качестве практического результата был создан веб-сервис, представляющий из себя бета-версию интерактивной карты районов Санкт-Петербурга, размеченную по уровню эмоциональной напряженности с учетом полученной при анализе датасетов информации.
1. Данные
Нами было проведено исследование общественной активности жителей районов Санкт-Петербурга в коммуникативном пространстве социальной сети ВКонтакте. В выборку попали 36 публичных групп (по 2 крупные группы на один район). Для анализа поведенческих особенностей пользователей были построены тепловые карты активности постинга по дням недели, а также графики соотношения количества лайков и репостов (рис. 1).
Рис. 1. Слева: тепловая карта постов, сообщество города Кудрово, динамика постинга 2013-2021; справа: активность невербальной реакции индивидов на пост, соотношение лайков и репостов
Проведенное первичное исследование слабо структурированных текстовых данных (LDA) показало основной состав тем, обсуждаемых в группах, соотносящихся с районами города. Наиболее активное обсуждение строится вокруг трех основных тем: проблемы района, вопросы здравоохранения, семья. 
В качестве промежуточного результата была разработана методология сбора текстовых данных, релевантная дальнейшей цели разметки собранного корпуса для нанесения информации об эмоциональном состоянии на карту. Было принято решение первично оценивать нулевой пост на предмет наличия ощутимой реакции со стороны пользователей, если она есть, то мы выкачивали комментарии (сохраняя служебную информацию с целью при необходимости иметь возможность вручную проанализировать ретроспективу беседы). Это было сделано для того, чтобы оставить за пределами проводимого анализа посты бытового характера (например, сообщения про утерянные ключи, время работы районных администраций и т.п.).
Далее мы ввели временное ограничение и выкачали цепочки диалогов только за 12 ближайших к исследованию месяца. Так как было до конца неясно, какой алгоритм анализа тональностей нам подойдет (из-за специфики дискурса социальных сетей – короткие сообщения, часто присутствие ненормативной лексики без выраженной отсылки к негативу и т.п.). К тому же необходимо было получить минимальный тестовый результат, чтобы определиться, какой именно концепт разметки тональности комментариев нас устроит для создания веб-сервиса с картой социального настроения жителей. 
Логика постинга комментариев во ВКонтакте изображена на рис.2.
Из схемы видно, что у n-го комментария могут быть также комментарии (и логически они связаны с ним). Встал вопрос, каким образом формировать итоговый датасет с необходимыми нам данными. Было принято решение оценивать на этом этапе анализа тональность всей группы комментариев. То есть в алгоритм мы считали нужным отправить комментарий #n в совокупности со всеми реакциями на него. 
Соответственно в итоге мы не оценивали реакцию социальной группы на n-го комментирующего, а ограничивались анализом общего эмоционального фона: иными словами, гипотеза заключалась в том, что вероятно через такую оценку тональности комментариев можно оценить уровень потенциальной агрессивности района. На рис. 3 представлен внешний вид собранного набора данных.
Рис. 2. Структура взаимодействия поста, комментариев и комментариев к комментариям
Рис. 3. Внешний вид датасета с комментариями пользователей
Стоит также отметить, что по каждому району датасет собирался отдельно (в соответствии с дальнейшей целью нанести результаты на карту).
2. Анализ тональности комментариев
Анализ тональности текста является одной из востребованных NLP-задач. Однако, несмотря на ее частотное появление в исследованиях, она имеет достаточно много преломлений: например, алгоритм может «захватывать» и оценивать эмоциональную окраску текста пользователя, а может «склоняться» к определению, был ли комментарий положительный по отношению к первоначальному контексту. Кроме того, тональность, содержащуюся в тексте, можно анализировать на уровне бинарной классификации (основа – выделение полярных пар, к примеру, «негативный-позитивный»), или детализировать на несколько классов (самая распространенная стратегия выделить три класса – «негативный», «нейтральный» и «позитивный», также часто используют пятибалльную шкалу – очень положительный, положительный, нейтральный, отрицательный и крайне отрицательный текст). 
Мы остановились на гипотезе, что бинарной классификации будет достаточно на данном этапе анализа эмоционального состояния жителей района.
В нашем исследовании был использован язык программирования python и его библиотеки для работы с текстом. Ниже приведена схема, демонстрирующая все возможные подходы к оценке тональности и библиотеки python, которые можно применить для этих целей (рис. 4).
Рис. 4. Подходы к оценке тональностей и соответствующие им python-библиотеки
Стоит коротко отметить, что существует ряд методов, которые основаны на применениях правил для детекции тональности текста, это подразумевает наличие заранее составленных тональных словарей. В целом процесс является трудоемким и на данный момент практически не используется. Что касается методов машинного обучения, то они основаны на анализе признаков. Модель машинного обучения сопоставляет набор входных данных (признаков) с предиктором (целевой переменной). Цель этого процесса состоит в том, чтобы модель изучила шаблон или сопоставление между этими входными данными и целевой переменной, чтобы затем модель могла предсказать целевую переменную на новых данных. Классические методы машинного обучения используют алгоритмы классификации с однослойной нейронной сетью, глубокое обучение требует наличия нескольких слоев в нейронной сети (при этом первый скрытый слой – это встраиваемый слой (embedding layer), который содержит контекстную информацию). При этом, чем лучше метод улавливает нюансы контекста, тем выше точность классификации настроений. Существует несколько методов кодирования текста с целью более точной фиксации контекста. 
В своем эксперименте мы остановились на классическом подходе к обучению, так как его преимущество заключается в автоматическом извлечении функций из необработанных данных с небольшой предварительной обработкой или без нее, а также такие методы требуют меньше ресурсов памяти.
Далее текстовые данные были поэтапно предобработаны по следующей схеме: 1) разбиение текстов реплик на токены; 2) удаление спецсимволов, ссылок и знаков пунктуации; 3) удаление стоп-слов; 4) нормализация токенов. 
Для взаимодействия с текстом была выбрана библиотека SpaCy, которая на данный момент является одним из самых популярных решений при обработке текста, в частности, она помогает размечать части речи и выделять именованные сущности. Ниже приведен рисунок, иллюстрирующий логику обработки данных в SpaCy (рис.5).
Рис. 5. Логика обработки данных SpaCy
Doc является центральной структурой данных в SpaCy, именно в нём хранятся последовательности токенов. Отметим, что для русского языка существует официальная модель от SpaCy, поддерживающая все основные операции. SpaCy автоматически присваивает выделенным токенам 300-мерные векторы на основе вложений слов GloVe. Поэтому задача генерации матрицы вложений для предложения видится довольно простой. Однако такой интуитивный подход не работает для небольших наборов данных. Проблема заключается в том, что по мере увеличения длины предложения количество признаков (т.е. размер матрицы) резко возрастает. Средняя длина предложения в собранных наборах данных – 13 слов. Выходит, что созданная матрица будет иметь размер (13, 300), с 3900 элементами. Поэтому мы нашли среднее значение матрицы для каждого элемента, и в итоге получили 300-мерный «средний» вектор для каждого предложения.
Метрикой качества для обучаемой модели была выбрана AUC ROC, которую можно интерпретировать как вероятность того, что элемент с положительной классификацией на самом деле является положительным, и насколько вероятно, что элемент с отрицательной классификацией является отрицательным (иными словами, показатель равен доле пар объектов вида «объект класса 1, объект класса 0», которые алгоритм верно упорядочил). Такая оценка более правильна в данной задаче, так как учитывает несбалансированность в наборе данных. Это важно, так как видится логичным, что большинство комментариев будут «притягиваться» к одному из классов в силу специфики выбранного дискурса.
3. Результаты эксперимента
Мы протестировали работу трех алгоритмов: логистическая регрессия, случайный лес и метод опорных векторов. Ниже представлена статистика успешности (рис. 6).
Рис. 6. Сравнение качества работы алгоритмов
Из графиков видно, что SVC является лучшим, но определение нового пространства признаков влечет за собой значительные вычислительные затраты, а обучение занимает в 35 раз больше времени, чем логистическая регрессия (для относительно небольшого улучшения 0,01 AUC ROC). Второй по успешности алгоритм – логистическая регрессия. Стоит также отметить, что точная настройка этой модели была довольно простой, так как у нее есть только один параметр, который действительно можно изменить (обратное значение силы регуляризации). Этот параметр контролирует, насколько могут варьироваться коэффициенты. Это предотвращает переоснащение данных. Логистическая регрессия дала следующую кривую обучения (рис. 7):
Рис. 7. Анализ успешности работы логистической регрессии
Графики показывают успех модели в обучающем наборе и наборе перекрестной проверки (набор перекрестной проверки был сделан с 20% данных) при увеличении обучающего набора со 100 образцов до всех доступных обучающих данных (80%). Успех этого алгоритма подкрепляется тем, что использование среднего значения векторов слов в предложении является эффективным способом уловить настроение в предложении, поскольку оно линейно отображает, было ли предложение положительным.
Заключение
В ходе исследования нами были сравнены алгоритмы, используемые для оценки тональности текста. В дальнейшем для исследования будет использоваться логистическая регрессия, так как она показала оптимальный результат. За пределами данного эксперимента остался анализ методов глубокого обучения, но для решения текущих задач такие модели видятся избыточными. 
В итоге мы получили размеченный датасет с двумя новыми признаками: класс тональности (негативный/позитивный) и процент вероятности отношения к этому классу (использовалась для дальнейшего картирования). Реализация получившегося веб-сервиса в бетта-режиме доступна по адресу https://frantsuzova.github.io/spb_map/.
Далее мы планируем выбрать более сложную формулу определения эмоциональной составляющей онлайн-дискурса жителей района и разработать методику комплексной оценки социального настроения горожан.